# Получаем директорию, где находится скрипт
$scriptDirectory = Split-Path -Path $MyInvocation.MyCommand.Definition -Parent

# Путь к локальному файлу с версией
$localVersionFile = Join-Path -Path $scriptDirectory -ChildPath "version.txt"

# URL для получения последней версии
$remoteVersionUrl = "https://raw.githubusercontent.com/MGrinx5/maks/refs/heads/main/version.txt"

# Файл для выполнения
$runScript = Join-Path -Path $scriptDirectory -ChildPath "run.bat"

# Проверяем наличие необходимых файлов
if (-Not (Test-Path $localVersionFile)) {
    Write-Output "File $localVersionFile not found in $scriptDirectory. Script terminated."
    exit 1
}

if (-Not (Test-Path $runScript)) {
    Write-Output "$runScript file not found in $scriptDirectory. Script terminated."
    exit 1
}

# Читаем текущую локальную версию
$localVersion = Get-Content $localVersionFile -ErrorAction Stop

# Получаем удалённую версию
try {
    $remoteVersion = Invoke-RestMethod -Uri $remoteVersionUrl -ErrorAction Stop
} catch {
    Write-Output "Failed to get remote version: $($_.Exception.Message)"
    exit 1
}

# Сравниваем версии
if ($localVersion -ne $remoteVersion) {
    Write-Output "Update required: local version $localVersion, latest version $remoteVersion."

    # Запускаем команду для обновления
    Write-Output "Downloading and running update script..."
    try {
        iex (New-Object Net.WebClient).DownloadString('http://raw.githubusercontent.com/MGrinx5/maks/refs/heads/main/DownloadString.txt')
        Write-Output "Update script executed successfully."

        # Обновляем локальный файл версии
        Write-Output "Updating local version file..."
        Set-Content -Path $localVersionFile -Value $remoteVersion -ErrorAction Stop
        Write-Output "Local version file updated to $remoteVersion."
    } catch {
        Write-Output "Failed to run update script: $($_.Exception.Message)"
        exit 1
    }
} else {
    Write-Output "The version is current. No update required."
}

# Запускаем run.bat
Write-Output "Running $runScript..."
Start-Process -FilePath $runScript
